#include <gtest/gtest.h>
#include <fstream>
#include <modularml>
#include "datastructures/tensor_utility.hpp"

#define INPUT_TENSOR_SHAPE 1, 1, 32, 32
#define INPUT_TENSOR_DATA -0.49446937441825867, 0.3053343594074249, -0.37283211946487427, 0.5277310609817505, -0.9436180591583252, 1.1557469367980957, 1.9404913187026978, -0.5212336778640747, 2.4980568885803223, 0.4938678443431854, 0.24021390080451965, -1.388093113899231, -0.3521275222301483, 1.6557990312576294, -0.11740101873874664, 0.775926411151886, -0.4562761187553406, -0.1758217066526413, 0.05664288252592087, -0.17374417185783386, -0.194447860121727, -0.18133938312530518, -0.5930216312408447, 0.8196173310279846, 0.7257211208343506, 0.31460264325141907, -0.5718518495559692, 1.4506837129592896, 1.1872056722640991, -0.9278667569160461, -0.7208399176597595, 1.4703831672668457, -1.3146109580993652, -1.4146989583969116, 0.9062108993530273, -1.2570195198059082, 1.7699047327041626, -1.208709955215454, -1.6337045431137085, 0.16261988878250122, 0.5151893496513367, -0.39296969771385193, 0.7469739317893982, 1.0932717323303223, 0.3862456679344177, -0.37579357624053955, -0.951594889163971, -0.5598556399345398, -2.2146317958831787, 1.115215539932251, -0.3580484688282013, -1.359041452407837, -0.45384418964385986, -1.0955893993377686, 0.6752263903617859, 0.7699439525604248, 1.5810306072235107, -0.6870259046554565, -0.8943983912467957, -0.5801297426223755, -0.7467426061630249, -0.19229523837566376, 0.4266625940799713, -0.9012913107872009, -1.2776809930801392, -0.14516682922840118, 0.2914655804634094, -0.6378250122070312, -0.37902045249938965, 1.55851149559021, 0.6941497325897217, -0.15469183027744293, -0.8895952105522156, 0.11384861171245575, 1.6426922082901, 0.9840992093086243, -0.5788480639457703, 2.1304173469543457, 0.5197575092315674, -0.15606634318828583, -0.09827963262796402, 1.0346640348434448, 0.10795237123966217, -0.9179843068122864, -0.3249613642692566, -0.3338008224964142, 1.0160715579986572, 0.5315365195274353, -0.24805274605751038, -0.5690973401069641, 0.2007746547460556, 0.22901491820812225, -0.14728781580924988, 1.2173138856887817, 0.26827290654182434, -0.6503090262413025, 0.4550763666629791, 0.2549813985824585, 1.24728524684906, 0.10347339510917664, 1.3914328813552856, 0.2523294985294342, 0.3908713459968567, -1.1372965574264526, -0.06864064931869507, 1.3229491710662842, 1.7249537706375122, -1.6225969791412354, 0.7505835294723511, -1.0631016492843628, -0.6275937557220459, 1.3249833583831787, 0.6402392983436584, 0.9683361649513245, 0.7619227170944214, -0.9638126492500305, -1.14139723777771, -0.5391074419021606, 0.11772868037223816, -1.0940181016921997, -0.9613019824028015, 0.06333383917808533, 0.9013999700546265, 0.4004226326942444, -0.3131054639816284, 1.1115013360977173, -0.5203378796577454, 1.0984114408493042, 0.07619061321020126, -0.3128474950790405, -0.20703066885471344, -1.5817301273345947, 0.8163755536079407, 1.4755712747573853, -1.117302656173706, 2.0615315437316895, -0.7079124450683594, 1.2824839353561401, 0.569915771484375, 1.1068073511123657, -0.9005396962165833, -0.9746284484863281, -1.4070379734039307, 0.3541024327278137, -1.692195177078247, -1.0237528085708618, 1.5283621549606323, 1.0503795146942139, 0.015373335219919682, -1.3632029294967651, 0.5176529288291931, -0.012379948049783707, 0.802478551864624, -0.676291823387146, 0.40683653950691223, 0.16901275515556335, 0.159920334815979, -1.4151376485824585, 2.0943851470947266, 0.05055505782365799, 1.217972755432129, -1.4612443447113037, -0.7918683886528015, -1.1299501657485962, 1.5868580341339111, -1.6061592102050781, -0.8224162459373474, -0.7437111735343933, 0.16744877398014069, -0.6819005608558655, -0.8532699942588806, -0.5809478759765625, 0.406263142824173, 1.7498360872268677, 0.10890187323093414, -0.6828847527503967, 0.8014723658561707, 1.0544990301132202, 0.4213292598724365, -1.6973475217819214, 0.15505366027355194, 0.7467985153198242, -1.42404043674469, 0.6225656270980835, 2.0181884765625, 1.8285558223724365, -0.3656652271747589, 1.4358863830566406, -2.8831682205200195, -0.08530745655298233, -0.7563714385032654, -0.20114882290363312, -1.1683216094970703, 0.7148784399032593, -2.265803098678589, -1.0714960098266602, -0.8333450555801392, 1.2732818126678467, 1.0805644989013672, -0.005699864588677883, 0.28332075476646423, -1.3944785594940186, 0.8148602247238159, 1.0691717863082886, 0.35480374097824097, 0.6325255632400513, -0.04023391008377075, -0.4298328757286072, 2.3674097061157227, 0.34320202469825745, 0.03990938141942024, 2.397028684616089, -0.8347653150558472, 0.26397982239723206, -0.7933835387229919, -0.15389356017112732, -0.9689763188362122, 1.2926753759384155, -1.1081068515777588, 0.40731894969940186, -0.4999597668647766, -0.38677576184272766, 0.8444027900695801, 1.5871692895889282, 0.019448306411504745, -0.3541388511657715, 0.2351200133562088, -1.0475356578826904, 0.9066239595413208, 3.385591506958008, -0.9682260155677795, 0.260166734457016, -0.9124031662940979, 0.29770368337631226, -1.8017889261245728, -1.874001145362854, -0.40158554911613464, -1.817097783088684, -0.785269021987915, -0.09193454682826996, 0.19572222232818604, -0.6852802634239197, 0.5479050278663635, -1.0574193000793457, 0.2986941337585449, -0.4118843078613281, -0.15954232215881348, 0.12300776690244675, 0.7921884059906006, -0.16741995513439178, -0.685637891292572, -1.7697346210479736, -1.4082480669021606, 0.5164242386817932, 0.8343543410301208, 0.2086166888475418, -1.2801371812820435, 1.924448013305664, 0.7893431186676025, -1.1010545492172241, 0.5726703405380249, -0.5725675821304321, 0.9309753179550171, 1.5226552486419678, 2.5699779987335205, -0.03840191662311554, -1.1308579444885254, -1.3468533754348755, -0.3884766399860382, -0.9693447947502136, 0.6346040964126587, 1.0306721925735474, -0.2526620328426361, 0.6600083708763123, -0.13566136360168457, -0.5820709466934204, 1.6901729106903076, -0.21411840617656708, 0.8129637837409973, -0.05098070949316025, 0.5308125019073486, 2.594794511795044, 1.3155804872512817, -0.6951004266738892, 1.2215449810028076, 1.859567642211914, 0.5513485670089722, -2.382235288619995, 0.2231827676296234, 1.1741664409637451, -1.7782957553863525, -0.5046679377555847, 0.8816531896591187, -0.11884448677301407, 1.2938579320907593, 0.24304567277431488, -0.16953875124454498, -0.43991461396217346, -0.6707020401954651, -0.028818152844905853, -0.9754137992858887, -0.6209403276443481, -1.6598817110061646, 0.04914533719420433, 1.070949912071228, 0.533685564994812, -0.10908744484186172, 0.1903274655342102, -0.7063893675804138, -0.03257705643773079, 0.5010601282119751, 0.07969719171524048, -1.711384892463684, -0.32352137565612793, -1.4109517335891724, 0.943316638469696, 0.9868016242980957, -1.4332811832427979, -1.1830809116363525, -1.192763090133667, -1.6050854921340942, 0.4337075352668762, 1.6644502878189087, -1.2105610370635986, 0.5169153809547424, 0.3798096477985382, -1.0563130378723145, 0.0907645970582962, -0.2707426846027374, -2.032399892807007, 0.8754273653030396, -0.842949390411377, 0.7356640100479126, 0.9788222908973694, -0.05440475791692734, 0.012207964435219765, 0.2879916727542877, -1.784040093421936, -0.8518607020378113, 1.3373922109603882, -0.21408316493034363, -1.091554880142212, 1.387123703956604, -0.10862249881029129, 0.29293063282966614, 0.7618433833122253, 0.6552936434745789, 0.7121801972389221, 0.6108269095420837, -0.4212794601917267, -0.4550771117210388, 0.5546325445175171, 0.5961052179336548, 1.1416370868682861, -0.9507957100868225, 1.5534456968307495, -0.6501001119613647, -0.3498951494693756, -0.2685178220272064, -0.09397634863853455, 1.3247179985046387, -0.07138177752494812, -1.9142200946807861, -0.6613015532493591, -0.5946948528289795, -1.128794550895691, -0.09014636278152466, 0.5673337578773499, -0.4948454201221466, -1.4898563623428345, -0.5527719259262085, 0.026284141466021538, -0.20330491662025452, 0.3873703181743622, -0.17914456129074097, -1.0541108846664429, 2.491173267364502, -0.8482231497764587, 1.4035158157348633, 0.7846423387527466, -0.20197124779224396, -0.7213670015335083, -0.49678564071655273, 0.6876990795135498, -0.04534801468253136, -0.8232367038726807, 1.8913291692733765, 2.2887279987335205, 0.23080627620220184, 0.8789558410644531, 0.5785745978355408, -1.0490816831588745, 0.9676488041877747, -0.055251963436603546, 0.9269318580627441, -0.9010624885559082, -0.26391562819480896, -0.9232786297798157, -1.166420817375183, 0.3786821663379669, -0.14021551609039307, 0.5136718153953552, -0.9129262566566467, -0.3906426429748535, 0.6896260976791382, -0.42163246870040894, 0.20101769268512726, 0.1148412749171257, 1.4193809032440186, 0.38985368609428406, 0.03927362337708473, -0.2893892824649811, -0.6808933019638062, -0.2469482123851776, 0.767957866191864, -0.2755964696407318, 0.8134143948554993, 0.2744666039943695, 1.0663245916366577, 1.3150537014007568, 0.41240888833999634, 0.5279337763786316, -1.3013578653335571, -2.018857955932617, 0.9565179347991943, -0.32055580615997314, 0.43951165676116943, -1.8994392156600952, -0.45167335867881775, -0.04190815985202789, 0.48801109194755554, -1.781209945678711, -0.23570924997329712, 0.0495762974023819, -2.1146843433380127, 0.4004894495010376, -1.4695454835891724, 0.02543397806584835, 0.7489619255065918, -1.1144016981124878, -0.07859889417886734, -0.17632895708084106, -1.0959643125534058, 1.5241209268569946, 0.2110121250152588, 0.9570819735527039, 0.3008155822753906, 0.29374343156814575, 0.936633825302124, -1.5943244695663452, -1.3512088060379028, -0.14648699760437012, -0.2622535228729248, 1.5812751054763794, 1.5693585872650146, 0.14221826195716858, -0.41496381163597107, 2.372922897338867, -2.090726375579834, -2.041088819503784, -0.34894895553588867, -0.41210585832595825, 0.1048164963722229, -1.0442028045654297, -0.9101348519325256, 0.39590656757354736, -0.10078134387731552, -2.140334367752075, -1.0353751182556152, -1.0576348304748535, 0.8438709378242493, 1.3914555311203003, -0.5468167066574097, -0.18081195652484894, -2.858349561691284, 2.078347682952881, -2.2267701625823975, 0.09891709685325623, -0.8528038859367371, 1.6315665245056152, -2.201322317123413, 0.8017900586128235, 1.3201686143875122, -0.7442497611045837, 0.5417038798332214, -0.5075047016143799, -0.4016414284706116, 0.10611053556203842, -1.0487464666366577, 0.4527551233768463, -1.897530198097229, -0.6297958493232727, -1.1832290887832642, 1.6860121488571167, 0.19197553396224976, -0.2978484034538269, 2.0500524044036865, -0.809349536895752, 0.9425275325775146, -0.40224480628967285, -0.6884017586708069, 1.008766770362854, -1.5450448989868164, 1.2072733640670776, -1.5245985984802246, -1.2081375122070312, -0.5843423008918762, 0.3051110506057739, -0.0887771025300026, 0.908061146736145, 0.7075599431991577, 0.09235212206840515, -0.4175265431404114, 0.05736372992396355, -0.02419670671224594, -0.01850396767258644, 0.9249559640884399, 0.19207756221294403, 1.221964955329895, 2.3303921222686768, -0.22187764942646027, -0.8723347783088684, -0.21880173683166504, -0.4218466281890869, -1.0794423818588257, -1.3481365442276, -0.7258002161979675, -0.4529723525047302, -0.8859378099441528, 0.6594120860099792, 0.5233084559440613, 0.9660714864730835, -2.2012407779693604, 0.5627774596214294, 1.3324053287506104, -0.17850370705127716, 0.7878798842430115, 0.7373089790344238, -0.16548751294612885, -0.019748719409108162, -0.7539896965026855, 2.928870916366577, 0.6698680520057678, 0.5681418180465698, -0.5111743807792664, -1.1333853006362915, -0.12002073973417282, -0.3519938886165619, 0.8096765279769897, -0.22650444507598877, -0.9829781651496887, 1.9334471225738525, 1.6456526517868042, 0.6054872870445251, -0.7769959568977356, 0.17476820945739746, 0.4577192962169647, 1.7844594717025757, -1.416887640953064, -0.35201922059059143, 0.40028509497642517, -0.011253799311816692, 1.5500259399414062, -0.22259140014648438, -0.31148043274879456, -0.06671761721372604, 0.35043492913246155, 0.9634993672370911, 0.09378060698509216, 1.9745646715164185, -2.072636604309082, -0.9555634260177612, -0.8625994324684143, -1.5566229820251465, 0.9026055335998535, -0.7151187062263489, -0.5121123790740967, 0.5276600122451782, -0.3765953779220581, -0.2668960392475128, -0.058538831770420074, 1.2867203950881958, 1.12589430809021, -0.2558181583881378, 2.294280767440796, 1.4389442205429077, 0.7172813415527344, -0.49109822511672974, 1.9415909051895142, -0.18263903260231018, -1.4378737211227417, -0.5721537470817566, 2.1300694942474365, 1.2081390619277954, -0.34478524327278137, -1.1614680290222168, 1.0206286907196045, 0.4838264584541321, -1.2413026094436646, 0.5456821322441101, -2.2223563194274902, 1.0254921913146973, 2.2628731727600098, 0.9635148644447327, 0.8571779727935791, -0.9013810157775879, -0.8485092520713806, -1.5701583623886108, -0.3399188816547394, 0.7179664969444275, 0.06382773816585541, -0.4802963137626648, -0.23916910588741302, -1.68159019947052, -1.1281999349594116, 0.5779763460159302, -1.026565670967102, 0.9651595950126648, -0.9380161762237549, 1.608709454536438, 0.40978196263313293, -2.7089715003967285, 0.6665995121002197, -0.3812621533870697, -0.3557768762111664, -0.7728306651115417, 0.9225672483444214, 1.413467288017273, -0.4379412829875946, 0.6457022428512573, 0.06247074156999588, 1.1712476015090942, -0.554384171962738, -0.8746622800827026, 0.4360116422176361, -0.3735450208187103, 0.8365237712860107, -1.366713523864746, 0.08898726850748062, -0.49461880326271057, 0.22560882568359375, -0.9647011160850525, -0.877020001411438, -0.047916900366544724, -0.7863481640815735, -1.0955580472946167, -2.1638171672821045, 0.0828995481133461, -0.6395399570465088, 0.6620660424232483, -1.1395494937896729, -0.22996509075164795, 1.565159797668457, -0.42600181698799133, -0.17125672101974487, 1.4977222681045532, 0.2921971380710602, -0.4129136800765991, -0.5709229111671448, 0.4396136701107025, -0.7114397883415222, 0.29081201553344727, 0.516690194606781, -0.1295739710330963, -1.1412080526351929, -1.4388808012008667, -0.8374825716018677, -0.8057563900947571, 0.5005834102630615, -0.6495301127433777, 0.8878114819526672, 0.520569920539856, 0.2527483105659485, -1.4549205303192139, -0.1736920326948166, -0.38083845376968384, 0.08434616029262543, 1.5202419757843018, -0.48454907536506653, 0.03442034125328064, 0.5728511214256287, 0.08436494320631027, -0.5233508944511414, -0.3615031838417053, 0.9512212872505188, -0.34821176528930664, -1.2406080961227417, 2.158262252807617, 0.08658256381750107, 0.1461292803287506, -1.6044343709945679, 0.6644777655601501, 0.37491098046302795, -0.30786949396133423, 0.0647088885307312, 1.9380378723144531, 0.29637518525123596, 1.4205682277679443, 0.8980764746665955, -0.7719195485115051, -0.8775330185890198, 2.158060312271118, -0.9115423560142517, 0.5633498430252075, 2.4277215003967285, 1.1571913957595825, 1.0894997119903564, 0.3034254014492035, -1.8557472229003906, -0.7741038799285889, -0.5493391156196594, 0.5680741667747498, 0.06347107887268066, -1.6478400230407715, 0.0889829695224762, -0.1608189195394516, -1.3917336463928223, -1.014857292175293, -0.2880048155784607, -1.8063902854919434, -0.2451937347650528, 0.96443772315979, -0.27452632784843445, 0.43746984004974365, 1.0177843570709229, -0.496359258890152, -0.4805248975753784, 0.29647698998451233, 0.6337907910346985, 1.5845375061035156, -0.06103513762354851, 0.53019779920578, 1.2985351085662842, -0.7500241994857788, 1.7667689323425293, 0.48707351088523865, 0.15758521854877472, 0.3520553410053253, -0.5024214386940002, -0.8722374439239502, 1.081831455230713, -1.2511662244796753, -1.005698561668396, -0.627189040184021, -1.133988857269287, 0.815917432308197, 0.7561430931091309, 1.7217210531234741, -1.760878086090088, 0.11731957644224167, 2.9828832149505615, -0.6427921056747437, 1.008471965789795, 0.21116292476654053, -1.263450026512146, 0.23140887916088104, 0.07229164242744446, 1.2687044143676758, -1.2292300462722778, -0.2714197337627411, -0.5911864638328552, -0.7007082104682922, 2.172636032104492, 0.7718958258628845, 0.049336161464452744, -0.946044921875, -0.8522576093673706, 0.2225831001996994, -0.3336036801338196, -0.029896816238760948, -0.7427036166191101, 1.0429975986480713, -1.4000729322433472, 0.295259952545166, 0.4945696294307709, -3.4787158966064453, 0.3368131220340729, -0.1603214293718338, 0.28968074917793274, -0.6465237140655518, 0.9220358729362488, 1.9240652322769165, -1.7415984869003296, -1.29209566116333, 0.5861630439758301, -0.08312546461820602, 1.0305172204971313, -0.22470323741436005, -0.8351725339889526, 0.46385613083839417, 0.3982599377632141, 0.5303722023963928, 0.3142441213130951, -0.445433109998703, 0.3998046815395355, 1.3032382726669312, 1.5286632776260376, 2.113477945327759, -0.8149381279945374, 0.9624448418617249, -1.6571481227874756, -0.3072546720504761, -0.3512560725212097, -0.6751434803009033, 0.9468293786048889, 0.10547861456871033, 0.5485117435455322, 1.3080782890319824, 0.37788286805152893, 0.7688065767288208, -0.3928094506263733, -0.3443589508533478, -0.10559618473052979, -0.725070595741272, -1.27826726436615, 0.05488503351807594, -0.3046695291996002, -0.03685752674937248, -0.9353268146514893, -1.319044828414917, -0.2813911736011505, 0.06722268462181091, 0.6909419298171997, -1.160468339920044, -1.2961963415145874, 1.384565830230713, 0.9425085186958313, 0.81783527135849, -0.3715970814228058, -0.0676184594631195, -1.3578912019729614, -1.8243311643600464, 0.7041897177696228, -1.005246877670288, 0.002654802519828081, 0.24234728515148163, -0.979159951210022, -0.1599385291337967, 1.6276713609695435, 0.40980857610702515, -0.7283149361610413, -0.20409542322158813, 0.6831989288330078, 0.7584414482116699, 0.5853819251060486, 1.819814682006836, -0.3408844470977783, 1.5085796117782593, 0.4953107535839081, 0.5015590190887451, -0.08766589313745499, 1.4195672273635864, 0.3098379075527191, -0.06440278142690659, -0.6964791417121887, -1.1226743459701538, -1.630285620689392, -0.2762737572193146, -1.2644752264022827, 0.30604925751686096, -1.3385419845581055, 0.8824018836021423, -0.727763831615448, -0.06363514065742493, -1.16344153881073, -1.3143538236618042, -0.9715392589569092, 0.21716946363449097, 0.45160791277885437, -0.07267727702856064, -1.9086833000183105, -1.022976040840149, -0.05918312445282936, -0.47301384806632996, 0.8481224179267883, 0.8469157814979553, 2.062636613845825, -0.15788587927818298, -1.7797198295593262, 1.5173166990280151, -0.7069103121757507, 0.5897135734558105, 0.40158846974372864, -0.1709517389535904, 0.7842323184013367, -0.37882116436958313, -1.6366149187088013, 1.0109442472457886, -0.5466943383216858, 2.5078251361846924, -0.25843366980552673, -0.459137886762619, 0.713659942150116, -0.2338498830795288, 0.44532284140586853, -0.060222312808036804, -0.16311052441596985, -0.712277889251709, 0.9328437447547913, -0.7493078708648682, -0.9894382357597351, 1.1362299919128418, -0.0935734361410141, 0.6094037890434265, -0.3420238494873047, -0.2841140329837799, 0.3680597245693207, 0.9174782037734985, -0.7501533627510071, 0.9731304049491882, -1.9120371341705322, -1.554945945739746, -0.5212392210960388, 0.39677461981773376, -0.9596412181854248, 1.3029755353927612, 0.4856579899787903, 0.142510786652565, 1.461603045463562, 0.934464693069458, -0.03477814793586731, 0.5392265915870667, 0.16660185158252716, 0.23413428664207458, -1.4777787923812866, -1.238239049911499, -0.5416918992996216, -0.7057022452354431, -0.0921814888715744, 0.8688077330589294, 0.15969713032245636, -0.38697585463523865, -0.57366544008255, 0.08455009013414383, -0.6554903388023376, -0.5888426899909973, -1.9621998071670532, 0.2401520013809204, 0.676496684551239, 0.3567693531513214, -0.04342468082904816, -1.516376256942749, -1.3851032257080078, -0.637480616569519, 0.8970444798469543, -1.6007561683654785, -1.8273478746414185, -0.4701785743236542, 0.053477153182029724, -2.27199649810791, 0.4591759145259857, 0.8862399458885193, 0.06482677906751633, 0.7178633213043213, -0.8606026768684387, 1.6158612966537476, -1.2200021743774414, 0.5125564336776733, 1.9956258535385132, 0.030164705589413643, 0.49628400802612305, -0.15101973712444305, -0.8512724041938782, 0.26451319456100464, -1.295180320739746, -1.413985252380371, 0.9219207763671875, -1.740552544593811, -0.05637861415743828, 0.5226083993911743, 0.20648519694805145, 0.23624250292778015, -1.2769078016281128, 0.8238318562507629, 0.08314475417137146, -1.710087776184082, 0.11382336169481277, 0.22385640442371368, 0.2536030411720276, -1.1275138854980469, 0.9355147480964661, -0.7338414192199707, -1.761040449142456, -0.5570616722106934, -1.149410605430603, -0.14179842174053192, 0.2968772053718567, -1.9399336576461792, 0.49545061588287354, -0.3121139407157898, 0.11966190487146378, 0.23431001603603363, 0.8998326659202576, 0.7151014804840088, -0.9252529144287109, 0.8092439770698547, 1.1052608489990234, 0.3796234726905823, -0.48650509119033813, 0.3063565492630005, 0.20289373397827148, 0.20025686919689178, 0.1879647672176361, -0.2043265402317047, -0.7040709257125854, -1.519455909729004, -0.15719737112522125, 1.2013064622879028, -1.6593810319900513, 1.0447139739990234, 0.8393820524215698, 0.865621030330658, 0.42829206585884094, 2.7498350143432617, -0.13714541494846344, -1.6634042263031006, 0.6365436315536499, -0.9082382917404175, -0.06064021587371826, -0.7906477451324463, 0.3798098564147949, -1.3293944597244263, 0.4029136300086975, 0.5816702842712402

#define OUTPUT_TENSOR_SHAPE 1, 10
#define OUTPUT_TENSOR_DATA -2.309969902038574, -2.3464694023132324, -2.304861545562744, -2.3725674152374268, -2.250042676925659, -2.2923660278320312, -2.345233917236328, -2.3390109539031982, -2.247159957885742, -2.228898525238037

TEST(test_mml_tensor, test_parsing_and_running_model) {
    std::ifstream file("../test.json");
    ASSERT_TRUE(file.is_open()) << "Failed to open test.json file";

    json onnx_model;
    file >> onnx_model;
    file.close();

    Parser_mml parser;

    std::unique_ptr<Model> model_base;
    ASSERT_NO_THROW({
        model_base = parser.parse(onnx_model);
    }) << "Parser failed to parse the JSON file";

    ASSERT_NE(model_base, nullptr) << "Model is null";

    auto model = dynamic_cast<Model_mml*>(model_base.get());
    ASSERT_NE(model, nullptr) << "Model is not of type Model_mml";

    std::unordered_map<string, GeneralDataTypes> inputs;

    array_mml<uli> shape({1, 2});
    array_mml<float> values({0.5f, -0.5f});


    auto input_tensor = std::make_shared<Tensor_mml<float>>(shape, values);
    inputs["input"] = input_tensor;

    std::unordered_map<string, GeneralDataTypes> outputs;
    ASSERT_NO_THROW({
        outputs = model->infer(inputs);
    }) << "Inference failed on the parsed model";

    ASSERT_FALSE(outputs.empty()) << "Model produced no outputs";

    auto output_it = outputs.find("output");
    ASSERT_NE(output_it, outputs.end()) << "Expected output tensor not found";

    ASSERT_TRUE(std::holds_alternative<std::shared_ptr<Tensor<float>>>(output_it->second))
        << "Output is not a float tensor";

    auto output_tensor = std::get<std::shared_ptr<Tensor<float>>>(output_it->second);

    EXPECT_EQ(output_tensor->get_shape(), array_mml<uli>({1, 3}));

    // Dynamic cast to Tensor_mml<float> to access the data
    auto output_tensor_mml = std::dynamic_pointer_cast<Tensor_mml<float>>(output_tensor);
    ASSERT_NE(output_tensor_mml, nullptr) << "Failed to cast to Tensor_mml<float>";

    auto expected_output = array_mml<float>({-0.46211716f, -0.46211716f, -0.46211716f});

    for (uli i = 0; i < output_tensor_mml->get_size(); i++) {
        EXPECT_NEAR(output_tensor_mml->get_data()[i], expected_output[i], 1e-5);
    }
}

TEST(test_mml_tensor, test_parsing_and_running_lenet) {
    std::ifstream file("../lenet.json");
    ASSERT_TRUE(file.is_open()) << "Failed to open lenet.json file";

    json onnx_model;
    file >> onnx_model;
    file.close();

    Parser_mml parser;

    std::unique_ptr<Model> model_base;
    ASSERT_NO_THROW({
        model_base = parser.parse(onnx_model);
    }) << "Parser failed to parse the JSON file";

    ASSERT_NE(model_base, nullptr) << "Model is null";

    auto model = dynamic_cast<Model_mml*>(model_base.get());
    ASSERT_NE(model, nullptr) << "Model is not of type Model_mml";

    std::unordered_map<string, GeneralDataTypes> inputs;
    
    auto input_tensor = tensor_mml_p<float>({INPUT_TENSOR_SHAPE}, {INPUT_TENSOR_DATA});
    inputs["input"] = input_tensor;

    std::unordered_map<string, GeneralDataTypes> outputs;
    ASSERT_NO_THROW({
        outputs = model->infer(inputs);
    }) << "Inference failed on the parsed model";

    ASSERT_FALSE(outputs.empty()) << "Model produced no outputs";

    auto output_it = outputs.find("output");
    ASSERT_NE(output_it, outputs.end()) << "Expected output tensor not found";

    ASSERT_TRUE(std::holds_alternative<std::shared_ptr<Tensor<float>>>(output_it->second))
        << "Output is not a float tensor";

    auto output_tensor = std::get<std::shared_ptr<Tensor<float>>>(output_it->second);

    auto expected_output_tensor = tensor_mml_p<float>({OUTPUT_TENSOR_SHAPE}, {OUTPUT_TENSOR_DATA});


    ASSERT_TRUE(tensors_are_close(*output_tensor, *expected_output_tensor, 0.0125f));
}